#!/usr/bin/make -f

export CARGO_HOME = $(CURDIR)/debian/cargo
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
# the below avoids an FTBFS on mips64el with a GOT > 64kb
DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH)
ifeq ($(DEB_HOST_ARCH),mips64el)
 export RUSTFLAGS = -Ctarget-feature=+xgot
endif

# the below avoids an FTBFS on mips64el with a GOT > 64kb
DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH)
ifeq ($(DEB_HOST_ARCH),mips64el)
 xgot = -Ctarget-feature=+xgot
else
 xgot = 
endif

# Don't use paths that may change between builds.
# No need to care about $HOME
# because Cargo will not place any source in ~/.cargo.
# The build directory is a subdirectory of the source directory,
# so it doesn't need to be explicitly taken care of.
export RUSTFLAGS = --remap-path-prefix=$(CURDIR)=/remap-pwd $(xgot)


%:
	dh $@ --builddirectory=_build --buildsystem=meson

# TODO: Remove this, after Squeekboard can also be built with Debian packages only.
execute_before_dh_auto_configure:
	cargo vendor

# Add Rust compiler support to meson cross-file for cross-compilation
override_dh_auto_configure:
	# Check if cross-compiling
	if [ "$(DEB_BUILD_ARCH)" != "$(DEB_HOST_ARCH)" ]; then \
		echo "Cross-compiling for aarch64-unknown-linux-gnu"; \
		mkdir -p debian/.debhelper/generated/_source; \
		echo "[binaries]" > /tmp/cross-arm64.txt; \
		echo "c = 'aarch64-linux-gnu-gcc'" >> /tmp/cross-arm64.txt; \
		echo "cpp = 'aarch64-linux-gnu-g++'" >> /tmp/cross-arm64.txt; \
		echo "ar = 'aarch64-linux-gnu-ar'" >> /tmp/cross-arm64.txt; \
		echo "strip = 'aarch64-linux-gnu-strip'" >> /tmp/cross-arm64.txt; \
		echo "pkgconfig = 'pkg-config'" >> /tmp/cross-arm64.txt; \
		echo "cargo = '/root/.cargo/bin/cargo'" >> /tmp/cross-arm64.txt; \
		echo "rust = '/usr/local/bin/rustc-aarch64'" >> /tmp/cross-arm64.txt; \
		echo "" >> /tmp/cross-arm64.txt; \
		echo "[properties]" >> /tmp/cross-arm64.txt; \
		echo "rust_ld = 'aarch64-linux-gnu-gcc'" >> /tmp/cross-arm64.txt; \
		echo "pkg_config_libdir = '/usr/lib/aarch64-linux-gnu/pkgconfig'" >> /tmp/cross-arm64.txt; \
		echo "" >> /tmp/cross-arm64.txt; \
		echo "[host_machine]" >> /tmp/cross-arm64.txt; \
		echo "system = 'linux'" >> /tmp/cross-arm64.txt; \
		echo "cpu_family = 'aarch64'" >> /tmp/cross-arm64.txt; \
		echo "cpu = 'aarch64'" >> /tmp/cross-arm64.txt; \
		echo "endian = 'little'" >> /tmp/cross-arm64.txt; \
		dh_auto_configure -- --cross-file /tmp/cross-arm64.txt; \
	else \
		dh_auto_configure; \
	fi
